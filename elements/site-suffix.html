<dom-module id="site-suffix">
  <script src="/bower_components/better-share-button/dist/share-button.js">
  </script>
  <!-- Double imports: one for shady DOM, one for shadow DOM -->
  <link rel="stylesheet"
        href="/bower_components/better-share-button/dist/share-button.css">
  <link rel="import" type="css"
        href="/bower_components/better-share-button/dist/share-button.css">
  <link rel="import" href="google-analytics.html">

  <template>
    <share-button style="left: 50%;" id="share">
    </share-button>
    <div id="disqus_thread"></div>
    <!-- <a class="muut" href="https://muut.com/i/blockbyte/comments" type="dynamic"> -->
      <!-- BlockByte</a> -->
    <!-- <script src="//cdn.muut.com/1/moot.min.js"> -->
    <!-- </script> -->

    <google-analytics></google-analytics>
  </template>

  <script>
    Polymer({
      is: 'site-suffix',

      properties: {
        noDisqus: {
          type: Boolean,
          value: false,
        }
      },

      ready: function () {
        if (this.noDisqus) return;

        var share = this.$.share;
        var thread = this.$.disqus_thread;

        function patch(name, replacement) {
          var orig = document[name].bind(document);
          replacement = replacement.bind(document, orig);
          document[name] = function () {
            return replacement.apply(this, arguments);
          };
        }

        // XXX: Hack to make Disqus play nicely with shadow DOM.
        patch('getElementById', function (orig, id) {
          if (id === 'disqus_thread') return thread;
          else return orig(id);
        });

        console.log(this.shadowRoot);
        new ShareButton({ root: this.shadowRoot });

        window.disqus_config = function() {
          this.page.url = window.location.href.split('?', 1)[0];
          this.page.identifier = 'cache' +
                                 window.location.pathname.split('?', 1)[0];
        };

        var ds = document.createElement('script');
        ds.src = '//blockbyte.disqus.com/embed.js';
        ds.async = true;
        ds.setAttribute('data-timestamp', +new Date());

        (document.head || document.body).appendChild(ds);
      }
    });
  </script>
</dom-module>
